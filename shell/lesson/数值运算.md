# 数值运算

这一篇为 Shell 编程中的基本数值运算，这类运算包括：

- 数值（包括整数和浮点数）间的加、减、乘、除、求幂、求模等
- 产生指定范围的随机数
- 产生指定范围的数列

Shell 本身可以做整数运算，复杂一些的运算要通过外部命令实现，比如 `expr`，`bc`，`awk` 等。

另外，可通过 `RANDOM` 环境变量产生一个从 0 到 32767 的随机数，一些外部工具，比如 `awk` 可以通过 `rand()` 函数产生随机数。

而 `seq` 命令可以用来产生一个数列。下面对它们分别进行介绍。



**简单版**：

* 整数运算用 `((i++)) `/ `let i++`
* 浮点数用 `echo "scale=3; 1/13"  | bc`



### 整数运算

#### 范例：对某个数加1

以下几种方式都可以达到效果：

```bash
((i++))
let i++
expr $i + 1
echo $i+1|bc
echo $i 1 | awk '{printf $1+$2}'
```

累计计算 10000 次.

```bash
#!/bin/bash
# calc.sh

i=0;
while [ $i -lt 10000 ]
do
    ((i++))
done
echo $i
```

把 `((i++))` 行替换成下面的某一个

```bash
let i++;
i=$(expr $i + 1)
i=$(echo $i+1|bc)
i=$(echo "$i 1" | awk '{printf $1+$2;}')
```

各方法耗时如下：

* (()) 1.3s
* let 1.4s
* awk 11.6s
* expr 27.4
* bc 56.5s

通过上述比较可以发现 `(())` 的运算效率最高。而 `let` 作为 Shell 内置命令，效率也很高，但是 `expr`，`bc`，`awk` 的计算效率就比较低。所以，在 Shell 本身能够完成相关工作的情况下，建议优先使用 Shell 本身提供的功能。

> **纯粹加法时，只建议使用 `(())`**

但是 Shell 本身无法完成的功能，比如浮点运算，所以就需要外部命令的帮助。另外，考虑到 Shell 脚本的可移植性，在性能不是很关键的情况下，不要使用某些 Shell 特有的语法。

`let`，`expr`，`bc` 都可以用来求模，运算符都是 `%`，而 `let` 和 `bc` 可以用来求幂，运算符不一样，前者是 `**`，后者是 `^` 。例如：

#### 范例：求模

```bash
expr 5 % 2
let i=5%2
echo 5 % 2 | bc
((i=5%2))
```



#### 范例：求幂

```bash
let i=5**2
((i=5**2))
echo "5^2" | bc
```



#### 范例：进制转换

例如把 8 进制的 11 转换为 10 进制，则可以：

```bash
((8#11))
echo "obase=10;ibase=8;11" | bc -l
```

上面都是把某个进制的数转换为 10 进制的，如果要进行任意进制之间的转换还是 `bc` 比较灵活，因为它可以直接用 `ibase` 和 `obase` 分别指定进制源和进制转换目标。

> **建议使用 bc 命令**



#### 范例：ascii 字符编码

如果要把某些字符串以特定的进制表示，可以用 `od` 命令，例如默认的分隔符 `IFS` 包括空格、 `TAB` 以及换行，可以用 `man ascii` 佐证。

```bash
$ echo -n "$IFS" | od -c
0000000      t  n
0000003
$ echo -n "$IFS" | od -b
0000000 040 011 012
0000003
```



### 浮点运算

`let` 和 `expr` 都无法进行浮点运算，但是 `bc` 和 `awk` 可以。



#### 范例：求 1 除以 13，保留 3 位有效数字

```bash
$ echo "scale=3; 1/13"  | bc
.076

$ echo "1 13" | awk '{printf("%0.3f\n",$1/$2)}'
0.077
```



#### 范例：余弦值转角度

用 `bc -l` 计算，可以获得高精度：

```bash
$ export cos=0.996293; echo "scale=100; a(sqrt(1-$cos^2)/$cos)*180/(a(1)*4)" | bc -l
4.934954755411383632719834036931840605159706398655243875372764917732
5495504159766011527078286004072131
```

当然也可以用 `awk` 来计算：

```bash
$ echo 0.996293 | awk '{ printf("%s\n", atan2(sqrt(1-$1^2),$1)*180/3.1415926535);}'
4.93495
```



### 随机数

环境变量 `RANDOM` 产生从 0 到 32767 的随机数，而 `awk` 的 `rand()` 函数可以产生 0 到 1 之间的随机数。

#### 范例：获取一个随机数

```bash
$ echo $RANDOM
81

$ echo "" | awk '{srand(); printf("%f", rand());}'
0.237788
```



#### 范例：随机产生一个从 0 到 255 之间的数字

可以通过 `RANDOM` 变量的缩放和 `awk` 中 `rand()` 的放大来实现。

```bash
$ expr $RANDOM / 128

$ echo "" | awk '{srand(); printf("%d\n", rand()*255);}'
```





### 其他运算

#### 范例：获取一系列数

for 循环可以实现，不过也可以使用 `seq` 命令：

```bash
$ seq 5
1
2
3
4
5
$ seq 1 5
1
2
3
4
5
$ seq 1 2 5
1
3
5
```

一个比较典型的使用 `seq` 的例子，构造一些特定格式的链接，然后用 `wget` 下载这些内容：

```bash
for i in `seq -w 1 21`;do wget -c "http://thns.tsinghua.edu.cn/thnsebooks/ebook73/$i"; done
```

生成的 url 如下：

```bash
http://thns.tsinghua.edu.cn/thnsebooks/ebook73/01.pdf
http://thns.tsinghua.edu.cn/thnsebooks/ebook73/02.pdf
http://thns.tsinghua.edu.cn/thnsebooks/ebook73/03.pdf
.....
http://thns.tsinghua.edu.cn/thnsebooks/ebook73/20.pdf
http://thns.tsinghua.edu.cn/thnsebooks/ebook73/21.pdf
```



#### 范例：统计字符串中各单词出现次数

```bash
$ wget -c http://tinylab.org
$ cat index.html | sed -e "s/[^a-zA-Z]/\n/g" | grep -v ^$ | sort | uniq -c | sort -n -k 1 -r | head -10
    524 a
    238 tag
    205 href
    201 class
    193 http
    189 org
    175 tinylab
    174 www
    146 div
    128 title
```



#### 范例：统计指定单词出现次数

可以考虑采取两种办法：

- 只统计那些需要统计的单词
- 用上面的算法把所有单词的个数都统计出来，然后再返回那些需要统计的单词给用户

不过，这两种办法都可以通过下面的结构来实现。先看办法一：

```bash
#!/bin/bash
# statistic_words.sh

if [ $# -lt 1 ]; then
    echo "Usage: basename $0 FILE WORDS ...."
    exit -1
fi

FILE=$1
((WORDS_NUM=$#-1))

for n in $(seq $WORDS_NUM)
do
    # shift 是 Shell 内置变量（请通过 help shift 获取帮助)，它把用户从命令行中传入的参数依次往后移动位置，并把当前参数作为第一个参数即 $1，这样通过 $1就可以遍历用户所有输入的单词
    shift
    cat $FILE | sed -e "s/[^a-zA-Z]/\n/g" \
        | grep -v ^$ | sort | grep ^$1$ | uniq -c
done
```



#### 范例：素数

`factor` 命令可以产生某个数的所有素数。如：

```bash
$ factor 100
100: 2 2 5 5
```



### 小结
该篇主要介绍了：

- Shell 编程中的整数运算、浮点运算、随机数的产生、数列的产生
  - 整数
    - `((i++))`
    - `let i++`
  - 浮点运算
    - `echo "scale=3; 1/13"  | bc`
    - `echo "1 13" | awk '{printf("%0.3f\n",$1/$2)}'`
- Shell 的内置命令、外部命令的区别，以及如何查看他们的类型和帮助
  - 使用命令 type 进行查看
  - type let：let is a shell builtin
  - type expr：expr is hashed (/usr/bin/expr)
- Shell 脚本的几种执行办法
  - 是修改文件为可执行，直接在当前 Shell 下执行
    - 赋予 x 权限`./xxx.sh`
  - 接把脚本文件当成子 Shell （Bash）的一个参数传入
    - `bash xxx.sh` 
  - 通过 `bash` 的内置命令 `.` 或 `source` 执行
    - `source xxx.sh` 
    -  `. xxx.sh`
- 几个常用的 Shell 外部命令： `sed`，`awk`，`grep`，`uniq`，`sort` 等
- 范例：数字递增；求月均收入；自动获取 `IP` 地址；统计单词个数
